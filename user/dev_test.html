  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Neovim user documentation">

    <!-- algolia docsearch https://docsearch.algolia.com/docs/docsearch-v3/ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
    <link rel="preconnect" href="https://X185E15FPG-dsn.algolia.net" crossorigin />

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link href="help.css" rel="stylesheet">
    <link href="/highlight/styles/neovim.min.css" rel="stylesheet">

    <script src="/highlight/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <title> Dev_test - Neovim docs</title>
  </head>
  <body>
    <header class="container">
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a href="/" class="navbar-brand" aria-label="logo">
          <!--TODO: use <img src="….svg"> here instead. Need one that has green lettering instead of gray. -->
              <svg xmlns="http://www.w3.org/2000/svg" role="img" width="173" height="50" viewBox="0 0 742 214" aria-label="Neovim">
      <title>Neovim</title>
      <defs>
        <linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="a">
          <stop stop-color="#16B0ED" stop-opacity=".8" offset="0%" />
          <stop stop-color="#0F59B2" stop-opacity=".837" offset="100%" />
        </linearGradient>
        <linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="b">
          <stop stop-color="#7DB643" offset="0%" />
          <stop stop-color="#367533" offset="100%" />
        </linearGradient>
        <linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="c">
          <stop stop-color="#88C649" stop-opacity=".8" offset="0%" />
          <stop stop-color="#439240" stop-opacity=".84" offset="100%" />
        </linearGradient>
      </defs>
      <g fill="none" fill-rule="evenodd">
        <path
          d="M.027 45.459L45.224-.173v212.171L.027 166.894V45.459z"
          fill="url(#a)"
          transform="translate(1 1)"
        />
        <path
          d="M129.337 45.89L175.152-.149l-.928 212.146-45.197-45.104.31-121.005z"
          fill="url(#b)"
          transform="matrix(-1 0 0 1 305 1)"
        />
        <path
          d="M45.194-.137L162.7 179.173l-32.882 32.881L12.25 33.141 45.194-.137z"
          fill="url(#c)"
          transform="translate(1 1)"
        />
        <path
          d="M46.234 84.032l-.063 7.063-36.28-53.563 3.36-3.422 32.983 49.922z"
          fill-opacity=".13"
          fill="#000"
        />
        <g fill="#444">
          <path
            d="M227 154V64.44h4.655c1.55 0 2.445.75 2.685 2.25l.806 13.502c4.058-5.16 8.786-9.316 14.188-12.466 5.4-3.15 11.413-4.726 18.037-4.726 4.893 0 9.205.781 12.935 2.34 3.729 1.561 6.817 3.811 9.264 6.751 2.448 2.942 4.297 6.48 5.55 10.621 1.253 4.14 1.88 8.821 1.88 14.042V154h-8.504V96.754c0-8.402-1.91-14.987-5.729-19.757-3.82-4.771-9.667-7.156-17.544-7.156-5.851 0-11.28 1.516-16.292 4.545-5.013 3.032-9.489 7.187-13.427 12.467V154H227zM350.624 63c5.066 0 9.755.868 14.069 2.605 4.312 1.738 8.052 4.268 11.219 7.592s5.638 7.412 7.419 12.264C385.11 90.313 386 95.883 386 102.17c0 1.318-.195 2.216-.588 2.696-.393.48-1.01.719-1.851.719h-64.966v1.70c0 6.708.784 12.609 2.353 17.7 1.567 5.09 3.8 9.357 6.695 12.802 2.895 3.445 6.393 6.034 10.495 7.771 4.1 1.738 8.686 2.606 13.752 2.606 4.524 0 8.446-.494 11.762-1.483 3.317-.988 6.108-2.097 8.37-3.324 2.261-1.227 4.056-2.336 5.383-3.324 1.326-.988 2.292-1.482 2.895-1.482.784 0 1.388.3 1.81.898l2.352 2.875c-1.448 1.797-3.362 3.475-5.745 5.031-2.383 1.558-5.038 2.891-7.962 3.998-2.926 1.109-6.062 1.991-9.41 2.65a52.21 52.21 0 01-10.088.989c-6.152 0-11.762-1.064-16.828-3.19-5.067-2.125-9.415-5.225-13.043-9.298-3.63-4.074-6.435-9.06-8.415-14.96C310.99 121.655 310 114.9 310 107.294c0-6.408.92-12.323 2.76-17.744 1.84-5.421 4.493-10.093 7.961-14.016 3.467-3.922 7.72-6.991 12.758-9.209C338.513 64.11 344.229 63 350.624 63zm.573 6c-4.696 0-8.904.702-12.623 2.105-3.721 1.404-6.936 3.421-9.65 6.053-2.713 2.631-4.908 5.79-6.586 9.474S319.55 94.439 319 99h60c0-4.679-.672-8.874-2.013-12.588-1.343-3.712-3.232-6.856-5.67-9.43-2.44-2.571-5.367-4.545-8.782-5.92-3.413-1.374-7.192-2.062-11.338-2.062zM435.546 63c6.526 0 12.368 1.093 17.524 3.28 5.154 2.186 9.5 5.286 13.04 9.298 3.538 4.013 6.238 8.85 8.099 14.51 1.861 5.66 2.791 11.994 2.791 19.002 0 7.008-.932 13.327-2.791 18.957-1.861 5.631-4.561 10.452-8.099 14.465-3.54 4.012-7.886 7.097-13.04 9.254-5.156 2.156-10.998 3.234-17.524 3.234-6.529 0-12.369-1.078-17.525-3.234-5.155-2.157-9.517-5.242-13.085-9.254-3.57-4.013-6.285-8.836-8.145-14.465-1.861-5.63-2.791-11.95-2.791-18.957 0-7.008.93-13.342 2.791-19.002 1.861-5.66 4.576-10.496 8.145-14.51 3.568-4.012 7.93-7.112 13.085-9.299C423.177 64.094 429.017 63 435.546 63zm-.501 86c5.341 0 10.006-.918 13.997-2.757 3.99-1.838 7.32-4.474 9.992-7.909 2.67-3.435 4.664-7.576 5.986-12.428 1.317-4.85 1.98-10.288 1.98-16.316 0-5.965-.66-11.389-1.98-16.27-1.322-4.88-3.316-9.053-5.986-12.519-2.67-3.463-6-6.13-9.992-7.999-3.991-1.867-8.657-2.802-13.997-2.802s-10.008.935-13.997 2.802c-3.991 1.87-7.322 4.536-9.992 8-2.671 3.465-4.68 7.637-6.03 12.518-1.35 4.881-2.026 10.305-2.026 16.27 0 6.026.675 11.465 2.025 16.316 1.35 4.852 3.36 8.993 6.031 12.428 2.67 3.435 6 6.07 9.992 7.91 3.99 1.838 8.656 2.756 13.997 2.756z"
            fill="currentColor"
          />
          <path
            d="M530.57 152h-20.05L474 60h18.35c1.61 0 2.967.39 4.072 1.166 1.103.778 1.865 1.763 2.283 2.959l17.722 49.138a92.762 92.762 0 012.551 8.429c.686 2.751 1.298 5.5 1.835 8.25.537-2.75 1.148-5.499 1.835-8.25a77.713 77.713 0 012.64-8.429l18.171-49.138c.417-1.196 1.164-2.181 2.238-2.96 1.074-.776 2.356-1.165 3.849-1.165H567l-36.43 92zM572 61h23v92h-23zM610 153V60.443h13.624c2.887 0 4.78 1.354 5.682 4.06l1.443 6.856a52.7 52.7 0 015.097-4.962 32.732 32.732 0 015.683-3.879 30.731 30.731 0 016.496-2.57c2.314-.632 4.855-.948 7.624-.948 5.832 0 10.63 1.579 14.39 4.736 3.758 3.157 6.57 7.352 8.434 12.585 1.444-3.068 3.248-5.698 5.413-7.894 2.165-2.194 4.541-3.984 7.127-5.367a32.848 32.848 0 018.254-3.068 39.597 39.597 0 018.796-.992c5.111 0 9.653.783 13.622 2.345 3.97 1.565 7.307 3.849 10.014 6.857 2.706 3.007 4.766 6.675 6.18 11.005C739.29 83.537 740 88.5 740 94.092V153h-22.284V94.092c0-5.894-1.294-10.329-3.878-13.306-2.587-2.977-6.376-4.465-11.368-4.465-2.286 0-4.404.391-6.358 1.172a15.189 15.189 0 00-5.144 3.383c-1.473 1.474-2.631 3.324-3.474 5.548-.842 2.225-1.263 4.781-1.263 7.668V153h-22.37V94.092c0-6.194-1.249-10.704-3.744-13.532-2.497-2.825-6.18-4.24-11.051-4.24-3.19 0-6.18.798-8.976 2.391-2.799 1.593-5.399 3.775-7.804 6.54V153H610zM572 30h23v19h-23z"
            fill="currentColor"
            fill-opacity=".8"
          />
        </g>
      </g>
    </svg>
  
          <!--<img src="https://neovim.io/logos/neovim-logo.svg" width="173" height="50" alt="Neovim" />-->
        </a>
        <div id="docsearch"></div> <!-- algolia docsearch https://docsearch.algolia.com/docs/docsearch-v3/ -->
      </div>
    </nav>
  </header>

  <div class="container golden-grid help-body">
  <div class="col-wide">
  <a name="dev_test.txt" href="#dev-test"><h1 id="dev-test"> Dev_test</h1></a>
  <p>
    <i>
    Nvim <code>:help</code> pages, <a href="https://github.com/neovim/neovim/blob/master/src/gen/gen_help_html.lua">generated</a>
    from <a href="https://github.com/neovim/neovim/blob/master/runtime/doc/dev_test.txt">source</a>
    using the <a href="https://github.com/neovim/tree-sitter-vimdoc">tree-sitter-vimdoc</a> parser.
    </i>
  </p>
  <hr/>
  <div class="help-para">
Writing tests for Nvim

</div>
<div class="help-para">
<h2 id="_writing-tests-for-nvim" class="help-heading">Writing tests for Nvim</h2>


</div>
<div class="help-para">
Nvim has a powerful yet simple test framework. It's approximately 7x better
than whatever you use at work.

</div>
<div class="help-para">
Each test starts a new Nvim process (10-30ms) which is discarded after the
test finishes. You assert stuff using <code>t.eq()</code> and <code>screen:expect()</code> (which
automatically waits as needed). That's pretty much it.

</div>
<div class="help-para">
TODO: Expose the test framework as a public interface, for use in 3P plugins:
<a href="https://github.com/neovim/neovim/issues/34592">https://github.com/neovim/neovim/issues/34592</a>

</div>
<div class="help-para">
<h2 id="_test-framework" class="help-heading">Test framework</h2>


</div>
<div class="help-para">
Tests are broadly divided into unit tests (<code>test/unit/</code>), functional tests
(<code>test/functional/</code>) and old tests (<code>test/old/testdir/</code>).

</div>
<div class="help-para">
<div class="help-li" style=""> Unit testing is achieved by compiling the tests as a shared library which is
  loaded and called by [LuaJit FFI](<a href="https://luajit.org/ext_ffi.html">https://luajit.org/ext_ffi.html</a>).
</div><div class="help-li" style=""> Functional tests are driven by RPC, so they do not require LuaJit (as
  opposed to Lua). They are essentially "integration" tests, they test the
  full system. But they are fast.
</div>
</div>
<div class="help-para">
You can learn [Lua concepts 15 minutes](<a href="https://learnxinyminutes.com/docs/lua/">https://learnxinyminutes.com/docs/lua/</a>),
see also <a href="lua-guide.html#lua-guide">lua-guide</a>. Use any existing test as a template to start writing new
tests, or see <a href="dev_tools.html#dev-quickstart">dev-quickstart</a>.

</div>
<div class="help-para">
Tests are run by the <code>/cmake/RunTests.cmake</code> script using <code>busted</code> (a Lua test-runner).
For some failures, <code>.nvimlog</code> (or <code>$NVIM_LOG_FILE</code>) may provide insight.

</div>
<div class="help-para">
Depending on the presence of binaries (e.g., <code>xclip</code>) some tests will be
skipped.

</div>
<div class="help-para">
<h2 id="_test-layout" class="help-heading">Test Layout</h2>


</div>
<div class="help-para">
<div class="help-li" style=""> <code>/test/benchmark</code> : benchmarks
</div><div class="help-li" style=""> <code>/test/functional</code> : functional tests
</div><div class="help-li" style=""> <code>/test/unit</code> : unit tests
</div><div class="help-li" style=""> <code>/test/old/testdir</code> : old tests (from Vim)
</div><div class="help-li" style=""> <code>/test/config</code> : contains <code>*.in</code> files which are transformed into <code>*.lua</code>
  files using <code>configure_file</code> CMake command: this is for accessing CMake
  variables in Lua tests.
</div><div class="help-li" style=""> <code>/test/includes</code> : include-files for use by luajit <code>ffi.cdef</code> C definitions
  parser: normally used to make macros not accessible via this mechanism
  accessible the other way.
</div><div class="help-li" style=""> <code>/test/*/preload.lua</code> : modules preloaded by busted <code>--helper</code> option
</div><div class="help-li" style=""> <code>/test/**/testutil.lua</code> : common utility functions in the context of the test
  runner
</div><div class="help-li" style=""> <code>/test/**/testnvim.lua</code> : common utility functions in the context of the
  test session (RPC channel to the Nvim child process created by clear() for each test)
</div><div class="help-li" style=""> <code>/test/*/**/*_spec.lua</code> : actual tests. Files that do not end with
  <code>_spec.lua</code> are libraries like <code>/test/**/testutil.lua</code>, except that they have
  some common topic.
</div>
</div>
<div class="help-para">
<h2 id="_running-tests" class="help-heading">Running tests<span class="help-heading-tags">                                                   <span id="dev-run-test" class="help-tag"><a href="#dev-run-test">dev-run-test</a></span></h2>


</div>
<div class="help-para">
<h3 id="_executing-tests" class="help-heading">EXECUTING TESTS</h3>


</div>
<div class="help-para">
To run all tests (except "old" tests):<pre>make test</pre>
To run only _unit_ tests:<pre>make unittest</pre>
To run only _functional_ tests:<pre>make functionaltest</pre>
<h3 id="_legacy-tests" class="help-heading">LEGACY TESTS</h3>


</div>
<div class="help-para">
To run all legacy Vim tests:<pre>make oldtest</pre>
To run a _single_ legacy test file you can use either:<pre># Specify only the test file name, not the full path.
make oldtest TEST_FILE=test_syntax.vim</pre>
or:<pre>make test/old/testdir/test_syntax.vim</pre>
<h3 id="_debugging-tests" class="help-heading">DEBUGGING TESTS</h3>


</div>
<div class="help-para">
<div class="help-li" style=""> Each test gets a test id which looks like "T123". This also appears in the
  log file. Child processes spawned from a test appear in the logs with the
  _parent_ name followed by "/c". Example:<pre>DBG 2022-06-15T18:37:45.226 T57.58016.0   UI: flush
DBG 2022-06-15T18:37:45.226 T57.58016.0   inbuf_poll:442: blocking... events_enabled=0 events_pending=0
DBG 2022-06-15T18:37:45.227 T57.58016.0/c UI: stop
INF 2022-06-15T18:37:45.227 T57.58016.0/c os_exit:595: Nvim exit: 0
DBG 2022-06-15T18:37:45.229 T57.58016.0   read_cb:118: closing Stream (0x7fd5d700ea18): EOF (end of file)
INF 2022-06-15T18:37:45.229 T57.58016.0   on_proc_exit:400: exited: pid=58017 status=0 stoptime=0</pre>
</div><div class="help-li" style=""> You can set <code>$GDB</code> to [run functional tests under gdbserver](<a href="https://github.com/neovim/neovim/pull/1527">https://github.com/neovim/neovim/pull/1527</a>):
<pre><code class="language-sh">GDB=1 TEST_FILE=test/functional/api/buffer_spec.lua TEST_FILTER='nvim_buf_set_text works$' make functionaltest</code></pre></div>
</div>
<div class="help-para">
  Read more about <a href="dev_test.html#dev-filter-test">dev-filter-test</a>.

</div>
<div class="help-para">
  Then, in another terminal:<pre><code class="language-sh">gdb -ex 'target remote localhost:7777' build/bin/nvim</code></pre>

</div>
<div class="help-para">
  If <code>$VALGRIND</code> is also set it will pass <code>--vgdb=yes</code> to valgrind instead of
  starting gdbserver directly.

</div>
<div class="help-para">
  See <code>nvim_argv</code> in <code>test/functional/testnvim.lua</code>.

</div>
<div class="help-para">
<div class="help-li" style=""> Hanging tests can happen due to unexpected "press-enter" prompts. The
  default screen width is 50 columns. Commands that try to print lines longer
  than 50 columns in the command-line, e.g. <code>:edit very...long...path</code>, will
  trigger the prompt. Try using a shorter path, or <code>:silent edit</code>.
</div><div class="help-li" style=""> If you can't figure out what is going on, try to visualize the screen. Put
  this at the beginning of your test:<pre>local Screen = require('test.functional.ui.screen')
local screen = Screen.new()
screen:attach()</pre>
</div>
</div>
<div class="help-para">
  Then put <code>screen:snapshot_util()</code> anywhere in your test. See the comments in
  <code>test/functional/ui/screen.lua</code> for more info.

</div>
<div class="help-para">
<h3 id="_debugging-lua-test-code" class="help-heading">DEBUGGING LUA TEST CODE</h3>


</div>
<div class="help-para">
Debugging Lua test code is a bit involved. Get your shopping list ready, you'll
need to install and configure:

</div>
<div class="help-para">
<div class="help-li-num" style=""> [nvim-dap](<a href="https://github.com/mfussenegger/nvim-dap">https://github.com/mfussenegger/nvim-dap</a>)
</div><div class="help-li-num" style=""> [local-lua-debugger-vscode](<a href="https://github.com/mfussenegger/nvim-dap/wiki/Debug-Adapter-installation#local-lua-debugger-vscode">https://github.com/mfussenegger/nvim-dap/wiki/Debug-Adapter-installation#local-lua-debugger-vscode</a>)
</div><div class="help-li-num" style=""> [nlua](<a href="https://github.com/mfussenegger/nlua">https://github.com/mfussenegger/nlua</a>)
</div><div class="help-li-num" style=""> [one-small-step-for-vimkind](<a href="https://github.com/jbyuki/one-small-step-for-vimkind">https://github.com/jbyuki/one-small-step-for-vimkind</a>) (called <code>osv</code>)
</div><div class="help-li-num" style=""> A <code>nbusted</code> command in <code>$PATH</code>. This command can be a copy of <code>busted</code> with
   <code>exec '/usr/bin/lua5.1'"</code> replaced with <code>"exec '/usr/bin/nlua'"</code> (or the
   path to your <code>nlua</code>)
</div>
</div>
<div class="help-para">
The setup roughly looks like this:<pre>┌─────────────────────────┐
│ nvim used for debugging │◄────┐
└─────────────────────────┘     │
           │                    │
           ▼                    │
  ┌─────────────────┐           │
  │ local-lua-debug │           │
  └─────────────────┘           │
          │                     │
          ▼                     │
     ┌─────────┐                │
     │ nbusted │                │
     └─────────┘                │
          │                     │
          ▼                     │
     ┌───────────┐              │
     │ test-case │              │
     └───────────┘              │
          │                     │
          ▼                     │
  ┌────────────────────┐        │
  │ nvim test-instance │        │
  └────────────────────┘        │
    │   ┌─────┐                 │
    └──►│ osv │─────────────────┘
        └─────┘</pre>
With these installed you can use a configuration like this:<pre>local dap = require("dap")
local function free_port()
  local tcp = vim.loop.new_tcp()
  assert(tcp)
  tcp:bind('127.0.0.1', 0)
  local port = tcp:getsockname().port
  tcp:shutdown()
  tcp:close()
  return port
end
local name = "nvim-test-case" -- arbitrary name
local config = {
  name = name,
  -- value of type must match the key used in `dap.adapters["local-lua"] = ...` from step 2)
  type = "local-lua",
  request = "launch",
  cwd = "${workspaceFolder}",
  program = {
    command = "nbusted",
  },
  args = {
    "--ignore-lua",
    "--lazy",
    "--helper=test/functional/preload.lua",
    "--lpath=build/?.lua",
    "--lpath=?.lua",
    -- path to file to debug, could be replaced with a hardcoded string
    function()
      return vim.api.nvim_buf_get_name(0)
    end,
    -- You can filter to specific test-case by adding:
    -- '--filter="' .. test_case_name .. '"',
  },
  env = {
    OSV_PORT = free_port
  }
}
-- Whenever the config is used it needs to launch a second debug session that attaches to `osv`
-- This makes it possible to step into `exec_lua` code blocks
setmetatable(config, {
  __call = function(c)
    ---@param session dap.Session
    dap.listeners.after.event_initialized["nvim_debug"] = function(session)
      if session.config.name ~= name then
        return
      end
      dap.listeners.after.event_initialized["nvim_debug"] = nil
      vim.defer_fn(function()
        dap.run({
          name = "attach-osv",
          type = "nlua", -- value must match the `dap.adapters` definition key for osv
          request = "attach",
          port = session.config.env.OSV_PORT,
        })
      end, 500)
    end
    return c
  end,
})</pre>
You can either add this configuration to your <code>dap.configurations.lua</code> list as
described in <code>:help dap-configuration</code> or create it dynamically in a
user-command or function and call it directly via <code>dap.run(config)</code>. The latter
is useful if you use treesitter to find the test case around a cursor location
with a query like the following and set the <code>--filter</code> property to it.<pre><code class="language-query">(function_call
  name: (identifier) @name (#any-of? @name "describe" "it")
  arguments: (arguments
    (string) @str
  )
)</code></pre>
Limitations:

</div>
<div class="help-para">
<div class="help-li" style=""> You need to add the following boilerplate to each spec file where you want to
  be able to stop at breakpoints within the test-case code:<pre>if os.getenv("LOCAL_LUA_DEBUGGER_VSCODE") == "1" then
  require("lldebugger").start()
end</pre>
</div>
</div>
<div class="help-para">
  This is a [local-lua-debugger limitation](<a href="https://github.com/tomblind/local-lua-debugger-vscode?tab=readme-ov-file#busted">https://github.com/tomblind/local-lua-debugger-vscode?tab=readme-ov-file#busted</a>)
<div class="help-li" style=""> You cannot step into code of files which get baked into the nvim binary
  (such as <code>_core/*.lua</code> and <code>inspect.lua</code>).
</div>
</div>
<div class="help-para">
<h3 id="_filtering-tests" class="help-heading">Filtering tests<span class="help-heading-tags">                                              <span id="dev-filter-test" class="help-tag"><a href="#dev-filter-test">dev-filter-test</a></span></h3>


</div>
<div class="help-para">
<h3 id="_filter-by-name" class="help-heading">FILTER BY NAME</h3>


</div>
<div class="help-para">
Tests can be filtered by setting a pattern of test name to <code>TEST_FILTER</code> or <code>TEST_FILTER_OUT</code>.<pre>it('foo api',function()
  ...
end)
it('bar api',function()
  ...
end)</pre>
To run only test with filter name:<pre>TEST_FILTER='foo.*api' make functionaltest</pre>
To run all tests except ones matching a filter:<pre>TEST_FILTER_OUT='foo.*api' make functionaltest</pre>
<h3 id="_filter-by-file" class="help-heading">FILTER BY FILE</h3>


</div>
<div class="help-para">
To run a _specific_ unit test:<pre>TEST_FILE=test/unit/foo.lua make unittest</pre>
or<pre>cmake -E env "TEST_FILE=test/unit/foo.lua" cmake --build build --target unittest</pre>
To run a _specific_ functional test:<pre>TEST_FILE=test/functional/foo.lua make functionaltest</pre>
or<pre>cmake -E env "TEST_FILE=test/functional/foo.lua" cmake --build build --target functionaltest</pre>
To _repeat_ a test:<pre>BUSTED_ARGS="--repeat=100 --no-keep-going" TEST_FILE=test/functional/foo_spec.lua make functionaltest</pre>
or<pre>cmake -E env "TEST_FILE=test/functional/foo_spec.lua" cmake -E env BUSTED_ARGS="--repeat=100 --no-keep-going" cmake --build build --target functionaltest</pre>
<h3 id="_filter-by-tag" class="help-heading">FILTER BY TAG</h3>


</div>
<div class="help-para">
Tests can be "tagged" by adding <code>#</code> before a token in the test description.<pre>it('#foo bar baz', function()
  ...
end)
it('#foo another test', function()
  ...
end)</pre>
To run only the tagged tests:<pre>TEST_TAG=foo make functionaltest</pre>
<b>NOTE:</b>

</div>
<div class="help-para">
<div class="help-li" style=""> <code>TEST_FILE</code> is not a pattern string like <code>TEST_TAG</code> or <code>TEST_FILTER</code>. The
  given value to <code>TEST_FILE</code> must be a path to an existing file.
</div><div class="help-li" style=""> Both <code>TEST_TAG</code> and <code>TEST_FILTER</code> filter tests by the string descriptions
  found in <code>it()</code> and <code>describe()</code>.
</div>
</div>
<div class="help-para">
<h2 id="_writing-tests" class="help-heading">Writing tests<span class="help-heading-tags">                                                 <span id="dev-write-test" class="help-tag"><a href="#dev-write-test">dev-write-test</a></span></h2>


</div>
<div class="help-para">
<h3 id="_guidelines" class="help-heading">GUIDELINES</h3>


</div>
<div class="help-para">
<div class="help-li" style=""> Luajit needs to know about type and constant declarations used in function
  prototypes. The
  [testutil.lua](<a href="https://github.com/neovim/neovim/blob/master/test/unit/testutil.lua">https://github.com/neovim/neovim/blob/master/test/unit/testutil.lua</a>)
  file automatically parses <code>types.h</code>, so types used in the tested functions
  could be moved to it to avoid having to rewrite the declarations in the test
  files.
</div><div class="help-li" style="margin-left: 3rem;"> <code>#define</code> constants must be rewritten <code>const</code> or <code>enum</code> so they can be
    "visible" to the tests.
</div><div class="help-li" style=""> Use <code>pending()</code> to skip tests
  ([example](<a href="https://github.com/neovim/neovim/commit/5c1dc0fbe7388528875aff9d7b5055ad718014de#diff-bf80b24c724b0004e8418102f68b0679R18">https://github.com/neovim/neovim/commit/5c1dc0fbe7388528875aff9d7b5055ad718014de#diff-bf80b24c724b0004e8418102f68b0679R18</a>)).
  Do not silently skip the test with <code>if-else</code>. If a functional test depends on
  some external factor (e.g. the existence of <code>md5sum</code> on <code>$PATH</code>), _and_ you
  can't mock or fake the dependency, then skip the test via <code>pending()</code> if the
  external factor is missing. This ensures that the _total_ test-count
  (success + fail + error + pending) is the same in all environments.
</div><div class="help-li" style="margin-left: 3rem;"><b> Note:</b> <code>pending()</code> is ignored if it is missing an argument, unless it is
      [contained in an <code>it()</code> block](<a href="https://github.com/neovim/neovim/blob/d21690a66e7eb5ebef18046c7a79ef898966d786/test/functional/ex_cmds/grep_spec.lua#L11">https://github.com/neovim/neovim/blob/d21690a66e7eb5ebef18046c7a79ef898966d786/test/functional/ex_cmds/grep_spec.lua#L11</a>).
      Provide empty function argument if the <code>pending()</code> call is outside <code>it()</code>
      ([example](<a href="https://github.com/neovim/neovim/commit/5c1dc0fbe7388528875aff9d7b5055ad718014de#diff-bf80b24c724b0004e8418102f68b0679R18">https://github.com/neovim/neovim/commit/5c1dc0fbe7388528875aff9d7b5055ad718014de#diff-bf80b24c724b0004e8418102f68b0679R18</a>)).
</div>
</div>
<div class="help-para">
<h3 id="_where-tests-go" class="help-heading">WHERE TESTS GO</h3>


</div>
<div class="help-para">
Tests in <code>/test/unit</code> and <code>/test/functional</code> are divided into groups by the
semantic component they are testing.

</div>
<div class="help-para">
<div class="help-li" style=""> Unit tests (<code>test/unit/</code>) should match 1-to-1 with the structure of
  <code>src/nvim/</code>, because they are testing functions directly. E.g. unit-tests
  for <code>src/nvim/undo.c</code> should live in <code>test/unit/undo_spec.lua</code>.
</div><div class="help-li" style=""> Functional tests (<code>test/functional/</code>) are higher-level (plugins, UI, user
  input) than unit tests; they are organized by concept.
</div><div class="help-li" style="margin-left: 3rem;"> Try to find an existing <code>test/functional/*/*_spec.lua</code> group that makes
      sense, before creating a new one.
</div>
</div>
<div class="help-para">
<h3 id="_fixing-tests" class="help-heading">Fixing tests<span class="help-heading-tags">                                                    <span id="dev-fix-test" class="help-tag"><a href="#dev-fix-test">dev-fix-test</a></span></h3>


</div>
<div class="help-para">
<h3 id="_fixing-harness-warnings" class="help-heading">FIXING HARNESS WARNINGS</h3>


</div>
<div class="help-para">
&gt; Nvim session T123 took 2000 milliseconds to exit
&gt; This indicates a likely problem with the test even if it passed!

</div>
<div class="help-para">
This may indicate a leak, because Nvim waits on uv handles before exiting.
Example: <a href="https://github.com/neovim/neovim/pull/35768">https://github.com/neovim/neovim/pull/35768</a>

</div>
<div class="help-para">
<h3 id="_fixing-lint-failures" class="help-heading">FIXING LINT FAILURES</h3>


</div>
<div class="help-para">
<code>make lint</code> (and <code>make lintlua</code>) runs [LuaLS](<a href="https://github.com/LuaLS/lua-language-server/wiki/Annotations">https://github.com/LuaLS/lua-language-server/wiki/Annotations</a>)
on the test code.

</div>
<div class="help-para">
If a LuaLS/EmmyLS warning must be ignored, specify the warning code. Example:<pre><code class="language-lua">---@diagnostic disable-next-line: unused-vararg</code></pre>
<a href="https://github.com/LuaLS/lua-language-server/wiki/Annotations#diagnostic">https://github.com/LuaLS/lua-language-server/wiki/Annotations#diagnostic</a>

</div>
<div class="help-para">
Ignore the smallest applicable scope (e.g. inside a function, not at the top of
the file).

</div>
<div class="help-para">
<h2 id="_configuration" class="help-heading">Configuration<span class="help-heading-tags">                                                <span id="dev-test-config" class="help-tag"><a href="#dev-test-config">dev-test-config</a></span></h2>


</div>
<div class="help-para">
(TODO: clean this up, too many variables and some of them are not used anymore.)

</div>
<div class="help-para">
Test behaviour is affected by environment variables. Currently supported
(Functional, Unit, Benchmarks) (when Defined; when set to _1_; when defined,
treated as Integer; when defined, treated as String; when defined, treated as
Number; !must be defined to function properly):

</div>
<div class="help-para">
<div class="help-li" style=""> <code>BUSTED_ARGS</code> (F) (U): arguments forwarded to <code>busted</code>.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>CC</code> (U) (S): specifies which C compiler to use to preprocess files.
  Currently only compilers with gcc-compatible arguments are supported.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>GDB</code> (F) (D): makes nvim instances to be run under <code>gdbserver</code>. It will be
  accessible on <code>localhost:7777</code>: use <code>gdb build/bin/nvim</code>, type <code>target remote :7777</code> inside.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>GDBSERVER_PORT</code> (F) (I): overrides port used for <code>GDB</code>.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>LOG_DIR</code> (FU) (S!): specifies where to seek for valgrind and ASAN log files.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>VALGRIND</code> (F) (D): makes nvim instances to be run under <code>valgrind</code>. Log
  files are named <code>valgrind-%p.log</code> in this case. Note that non-empty valgrind
  log may fail tests. Valgrind arguments may be seen in
  <code>/test/functional/testnvim.lua</code>. May be used in conjunction with <code>GDB</code>.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>VALGRIND_LOG</code> (F) (S): overrides valgrind log file name used for <code>VALGRIND</code>.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>TEST_COLORS</code> (F) (U) (D): enable pretty colors in test runner. Set to true by default.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>TEST_SKIP_FRAGILE</code> (F) (D): makes test suite skip some fragile tests.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>TEST_TIMEOUT</code> (FU) (I): specifies maximum time, in seconds, before the test
  suite run is killed
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST</code> (FU) (D): lets Nvim process detect that it is running in a test.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_LUA_NOTRACK</code> (F) (D): disable reference counting of Lua objects
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_PRG</code> (F) (S): path to Nvim executable (default: <code>build/bin/nvim</code>).
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_MAIN_CDEFS</code> (U) (1): makes <code>ffi.cdef</code> run in main process. This
  raises a possibility of bugs due to conflicts in header definitions, despite
  the counters, but greatly speeds up unit tests by not requiring <code>ffi.cdef</code> to
  do parsing of big strings with C definitions.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_PRINT_I</code> (U) (1): makes <code>cimport</code> print preprocessed, but not yet
  filtered through <code>formatc</code> headers. Used to debug <code>formatc</code>. Printing is done
  with the line numbers.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_PRINT_CDEF</code> (U) (1): makes <code>cimport</code> print final lines which will
  be then passed to <code>ffi.cdef</code>. Used to debug errors <code>ffi.cdef</code> happens to
  throw sometimes.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_PRINT_SYSCALLS</code> (U) (1): makes it print to stderr when syscall
  wrappers are called and what they returned. Used to debug code which makes
  unit tests be executed in separate processes.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_RUN_FAILING_TESTS</code> (U) (1): makes <code>itp</code> run tests which are known
  to fail (marked by setting third argument to <code>true</code>).
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_CORE_*</code> (FU) (S): a set of environment variables which specify
  where to search for core files. Are supposed to be defined all at once.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_CORE_GLOB_DIRECTORY</code> (FU) (S): directory where core files are
  located. May be <code>.</code>. This directory is then recursively searched for core
  files.<b> Note:</b> this variable must be defined for any of the following to have
  any effect.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_CORE_GLOB_RE</code> (FU) (S): regular expression which must be matched
  by core files. E.g. <code>/core[^/]*$</code>. May be absent, in which case any file is
  considered to be matched.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_CORE_EXC_RE</code> (FU) (S): regular expression which excludes certain
  directories from searching for core files inside. E.g. use <code>^/%.deps$</code> to not
  search inside <code>/.deps</code>. If absent, nothing is excluded.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_CORE_DB_CMD</code> (FU) (S): command to get backtrace out of the
  debugger. E.g.gdb -n -batch -ex "thread apply all bt full"
  "$_NVIM_TEST_APP" -c "$_NVIM_TEST_CORE"`. Defaults to the example command.
  This debug command may use environment variables <code>_NVIM_TEST_APP</code> (path to
  application which is being debugged: normally either nvim or luajit) and
  <code>_NVIM_TEST_CORE</code> (core file to get backtrace from).
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_CORE_RANDOM_SKIP</code> (FU) (D): makes <code>check_cores</code> not check cores
  after approximately 90% of the tests. Should be used when finding cores is
  too hard for some reason. Normally (on OS X or when
  <code>NVIM_TEST_CORE_GLOB_DIRECTORY</code> is defined and this variable is not) cores
  are checked for after each test.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_INTEG</code> (F) (D): enables integration tests that makes real network
  calls. By default these tests are skipped. When set to <code>1</code>, tests requiring external
  HTTP requests (e.g <code>vim.net.request()</code>) will be run.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_RUN_TESTTEST</code> (U) (1): allows running
  <code>test/unit/testtest_spec.lua</code> used to check how testing infrastructure works.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_TRACE_LEVEL</code> (U) (N): specifies unit tests tracing level:
</div><div class="help-li" style="margin-left: 3rem;"> <code>0</code> disables tracing (the fastest, but you get no data if tests crash and
    there no core dump was generated),
</div><div class="help-li" style="margin-left: 3rem;"> <code>1</code> leaves only C function calls and returns in the trace (faster than
    recording everything),
</div><div class="help-li" style="margin-left: 3rem;"> <code>2</code> records all function calls, returns and executed Lua source lines.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_TRACE_ON_ERROR</code> (U) (1): makes unit tests yield trace on error in
  addition to regular error message.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>NVIM_TEST_MAXTRACE</code> (U) (N): specifies maximum number of trace lines to
  keep. Default is 1024.
</div>
</div>
<div class="help-para">
<div class="help-li" style=""> <code>OSV_PORT</code>: (F): launches <code>osv</code> listening on the given port within nvim test
  instances.
</div>
</div>

  </div>
      <div class="col-narrow toc">
      <div><a href="index.html">Main</a></div>
      <div><a href="vimindex.html">Commands index</a></div>
      <div><a href="quickref.html">Quick reference</a></div>
      <hr/>
  <div class="help-toc-h1"><a href="#_writing-tests-for-nvim">Writing tests for Nvim</a>
</div><div class="help-toc-h1"><a href="#_test-framework">Test framework</a>
</div><div class="help-toc-h1"><a href="#_test-layout">Test Layout</a>
</div><div class="help-toc-h1"><a href="#_running-tests">Running tests</a>
<div class="help-toc-h2"><a href="#_executing-tests">EXECUTING TESTS</a></div>
<div class="help-toc-h2"><a href="#_legacy-tests">LEGACY TESTS</a></div>
<div class="help-toc-h2"><a href="#_debugging-tests">DEBUGGING TESTS</a></div>
<div class="help-toc-h2"><a href="#_debugging-lua-test-code">DEBUGGING LUA TEST CODE</a></div>
<div class="help-toc-h2"><a href="#_filtering-tests">Filtering tests</a></div>
<div class="help-toc-h2"><a href="#_filter-by-name">FILTER BY NAME</a></div>
<div class="help-toc-h2"><a href="#_filter-by-file">FILTER BY FILE</a></div>
<div class="help-toc-h2"><a href="#_filter-by-tag">FILTER BY TAG</a></div>
</div><div class="help-toc-h1"><a href="#_writing-tests">Writing tests</a>
<div class="help-toc-h2"><a href="#_guidelines">GUIDELINES</a></div>
<div class="help-toc-h2"><a href="#_where-tests-go">WHERE TESTS GO</a></div>
<div class="help-toc-h2"><a href="#_fixing-tests">Fixing tests</a></div>
<div class="help-toc-h2"><a href="#_fixing-harness-warnings">FIXING HARNESS WARNINGS</a></div>
<div class="help-toc-h2"><a href="#_fixing-lint-failures">FIXING LINT FAILURES</a></div>
</div><div class="help-toc-h1"><a href="#_configuration">Configuration</a>
</div></div>
</div>
  <footer>
    <div class="container flex">
      <div class="generator-stats">
        Generated at 2026-01-28 05:32 from <code><a href="https://github.com/neovim/neovim/commit/027b7d6bbb4f164b95f1588b250a02020d85b029">027b7d6</a></code>
      </div>
      <div class="generator-stats">
      parse_errors: 0 (<a href="https://github.com/neovim/neovim/issues/new?labels=bug&title=user+docs+HTML%3A+dev_test.txt+&body=%60gen_help_html.lua%60+problem+at%3A+https://neovim.io/doc/user/dev_test.html%0D%0DContext%3A%0D%0D%60%60%60%0DTODO%0D%60%60%60" target="_blank">report docs bug...</a>) | <span title="          Nvim
                            NVIM REFERENCE MANUAL
                                  Type &lt;a href="various.html#gO"&gt;gO&lt;/a&gt; to see the table of contents.">noise_lines: 3</span>
      </div>
    <div>

    <!-- algolia docsearch https://docsearch.algolia.com/docs/docsearch-v3/ -->
    <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
    <script type="module">
      docsearch({
        container: '#docsearch',
        appId: 'X185E15FPG',
        apiKey: 'b5e6b2f9c636b2b471303205e59832ed',
        indexName: 'nvim',
      });
    </script>

  </footer>
  </body>
</html>
