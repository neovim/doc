  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Neovim user documentation">

    <!-- algolia docsearch https://docsearch.algolia.com/docs/docsearch-v3/ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
    <link rel="preconnect" href="https://X185E15FPG-dsn.algolia.net" crossorigin />

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link href="help.css" rel="stylesheet">
    <link href="/highlight/styles/neovim.min.css" rel="stylesheet">

    <script src="/highlight/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <title> Dev_arch - Neovim docs</title>
  </head>
  <body>
    <header class="container">
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a href="/" class="navbar-brand" aria-label="logo">
          <!--TODO: use <img src="….svg"> here instead. Need one that has green lettering instead of gray. -->
              <svg xmlns="http://www.w3.org/2000/svg" role="img" width="173" height="50" viewBox="0 0 742 214" aria-label="Neovim">
      <title>Neovim</title>
      <defs>
        <linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="a">
          <stop stop-color="#16B0ED" stop-opacity=".8" offset="0%" />
          <stop stop-color="#0F59B2" stop-opacity=".837" offset="100%" />
        </linearGradient>
        <linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="b">
          <stop stop-color="#7DB643" offset="0%" />
          <stop stop-color="#367533" offset="100%" />
        </linearGradient>
        <linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="c">
          <stop stop-color="#88C649" stop-opacity=".8" offset="0%" />
          <stop stop-color="#439240" stop-opacity=".84" offset="100%" />
        </linearGradient>
      </defs>
      <g fill="none" fill-rule="evenodd">
        <path
          d="M.027 45.459L45.224-.173v212.171L.027 166.894V45.459z"
          fill="url(#a)"
          transform="translate(1 1)"
        />
        <path
          d="M129.337 45.89L175.152-.149l-.928 212.146-45.197-45.104.31-121.005z"
          fill="url(#b)"
          transform="matrix(-1 0 0 1 305 1)"
        />
        <path
          d="M45.194-.137L162.7 179.173l-32.882 32.881L12.25 33.141 45.194-.137z"
          fill="url(#c)"
          transform="translate(1 1)"
        />
        <path
          d="M46.234 84.032l-.063 7.063-36.28-53.563 3.36-3.422 32.983 49.922z"
          fill-opacity=".13"
          fill="#000"
        />
        <g fill="#444">
          <path
            d="M227 154V64.44h4.655c1.55 0 2.445.75 2.685 2.25l.806 13.502c4.058-5.16 8.786-9.316 14.188-12.466 5.4-3.15 11.413-4.726 18.037-4.726 4.893 0 9.205.781 12.935 2.34 3.729 1.561 6.817 3.811 9.264 6.751 2.448 2.942 4.297 6.48 5.55 10.621 1.253 4.14 1.88 8.821 1.88 14.042V154h-8.504V96.754c0-8.402-1.91-14.987-5.729-19.757-3.82-4.771-9.667-7.156-17.544-7.156-5.851 0-11.28 1.516-16.292 4.545-5.013 3.032-9.489 7.187-13.427 12.467V154H227zM350.624 63c5.066 0 9.755.868 14.069 2.605 4.312 1.738 8.052 4.268 11.219 7.592s5.638 7.412 7.419 12.264C385.11 90.313 386 95.883 386 102.17c0 1.318-.195 2.216-.588 2.696-.393.48-1.01.719-1.851.719h-64.966v1.70c0 6.708.784 12.609 2.353 17.7 1.567 5.09 3.8 9.357 6.695 12.802 2.895 3.445 6.393 6.034 10.495 7.771 4.1 1.738 8.686 2.606 13.752 2.606 4.524 0 8.446-.494 11.762-1.483 3.317-.988 6.108-2.097 8.37-3.324 2.261-1.227 4.056-2.336 5.383-3.324 1.326-.988 2.292-1.482 2.895-1.482.784 0 1.388.3 1.81.898l2.352 2.875c-1.448 1.797-3.362 3.475-5.745 5.031-2.383 1.558-5.038 2.891-7.962 3.998-2.926 1.109-6.062 1.991-9.41 2.65a52.21 52.21 0 01-10.088.989c-6.152 0-11.762-1.064-16.828-3.19-5.067-2.125-9.415-5.225-13.043-9.298-3.63-4.074-6.435-9.06-8.415-14.96C310.99 121.655 310 114.9 310 107.294c0-6.408.92-12.323 2.76-17.744 1.84-5.421 4.493-10.093 7.961-14.016 3.467-3.922 7.72-6.991 12.758-9.209C338.513 64.11 344.229 63 350.624 63zm.573 6c-4.696 0-8.904.702-12.623 2.105-3.721 1.404-6.936 3.421-9.65 6.053-2.713 2.631-4.908 5.79-6.586 9.474S319.55 94.439 319 99h60c0-4.679-.672-8.874-2.013-12.588-1.343-3.712-3.232-6.856-5.67-9.43-2.44-2.571-5.367-4.545-8.782-5.92-3.413-1.374-7.192-2.062-11.338-2.062zM435.546 63c6.526 0 12.368 1.093 17.524 3.28 5.154 2.186 9.5 5.286 13.04 9.298 3.538 4.013 6.238 8.85 8.099 14.51 1.861 5.66 2.791 11.994 2.791 19.002 0 7.008-.932 13.327-2.791 18.957-1.861 5.631-4.561 10.452-8.099 14.465-3.54 4.012-7.886 7.097-13.04 9.254-5.156 2.156-10.998 3.234-17.524 3.234-6.529 0-12.369-1.078-17.525-3.234-5.155-2.157-9.517-5.242-13.085-9.254-3.57-4.013-6.285-8.836-8.145-14.465-1.861-5.63-2.791-11.95-2.791-18.957 0-7.008.93-13.342 2.791-19.002 1.861-5.66 4.576-10.496 8.145-14.51 3.568-4.012 7.93-7.112 13.085-9.299C423.177 64.094 429.017 63 435.546 63zm-.501 86c5.341 0 10.006-.918 13.997-2.757 3.99-1.838 7.32-4.474 9.992-7.909 2.67-3.435 4.664-7.576 5.986-12.428 1.317-4.85 1.98-10.288 1.98-16.316 0-5.965-.66-11.389-1.98-16.27-1.322-4.88-3.316-9.053-5.986-12.519-2.67-3.463-6-6.13-9.992-7.999-3.991-1.867-8.657-2.802-13.997-2.802s-10.008.935-13.997 2.802c-3.991 1.87-7.322 4.536-9.992 8-2.671 3.465-4.68 7.637-6.03 12.518-1.35 4.881-2.026 10.305-2.026 16.27 0 6.026.675 11.465 2.025 16.316 1.35 4.852 3.36 8.993 6.031 12.428 2.67 3.435 6 6.07 9.992 7.91 3.99 1.838 8.656 2.756 13.997 2.756z"
            fill="currentColor"
          />
          <path
            d="M530.57 152h-20.05L474 60h18.35c1.61 0 2.967.39 4.072 1.166 1.103.778 1.865 1.763 2.283 2.959l17.722 49.138a92.762 92.762 0 012.551 8.429c.686 2.751 1.298 5.5 1.835 8.25.537-2.75 1.148-5.499 1.835-8.25a77.713 77.713 0 012.64-8.429l18.171-49.138c.417-1.196 1.164-2.181 2.238-2.96 1.074-.776 2.356-1.165 3.849-1.165H567l-36.43 92zM572 61h23v92h-23zM610 153V60.443h13.624c2.887 0 4.78 1.354 5.682 4.06l1.443 6.856a52.7 52.7 0 015.097-4.962 32.732 32.732 0 015.683-3.879 30.731 30.731 0 016.496-2.57c2.314-.632 4.855-.948 7.624-.948 5.832 0 10.63 1.579 14.39 4.736 3.758 3.157 6.57 7.352 8.434 12.585 1.444-3.068 3.248-5.698 5.413-7.894 2.165-2.194 4.541-3.984 7.127-5.367a32.848 32.848 0 018.254-3.068 39.597 39.597 0 018.796-.992c5.111 0 9.653.783 13.622 2.345 3.97 1.565 7.307 3.849 10.014 6.857 2.706 3.007 4.766 6.675 6.18 11.005C739.29 83.537 740 88.5 740 94.092V153h-22.284V94.092c0-5.894-1.294-10.329-3.878-13.306-2.587-2.977-6.376-4.465-11.368-4.465-2.286 0-4.404.391-6.358 1.172a15.189 15.189 0 00-5.144 3.383c-1.473 1.474-2.631 3.324-3.474 5.548-.842 2.225-1.263 4.781-1.263 7.668V153h-22.37V94.092c0-6.194-1.249-10.704-3.744-13.532-2.497-2.825-6.18-4.24-11.051-4.24-3.19 0-6.18.798-8.976 2.391-2.799 1.593-5.399 3.775-7.804 6.54V153H610zM572 30h23v19h-23z"
            fill="currentColor"
            fill-opacity=".8"
          />
        </g>
      </g>
    </svg>
  
          <!--<img src="https://neovim.io/logos/neovim-logo.svg" width="173" height="50" alt="Neovim" />-->
        </a>
        <div id="docsearch"></div> <!-- algolia docsearch https://docsearch.algolia.com/docs/docsearch-v3/ -->
      </div>
    </nav>
  </header>

  <div class="container golden-grid help-body">
  <div class="col-wide">
  <a name="dev_arch.txt" href="#dev-arch"><h1 id="dev-arch"> Dev_arch</h1></a>
  <p>
    <i>
    Nvim <code>:help</code> pages, <a href="https://github.com/neovim/neovim/blob/master/src/gen/gen_help_html.lua">generated</a>
    from <a href="https://github.com/neovim/neovim/blob/master/runtime/doc/dev_arch.txt">source</a>
    using the <a href="https://github.com/neovim/tree-sitter-vimdoc">tree-sitter-vimdoc</a> parser.
    </i>
  </p>
  <hr/>
  <div class="help-para">
How to develop Nvim, explanation of modules and subsystems

</div>
<div class="help-para">
Module-specific details are documented at the top of each module
(<code>terminal.c</code>, <code>undo.c</code>, …). The top of each major module has (or should have)
an overview in a comment at the top of its file.

</div>
<div class="help-para">
The purpose of this document is to give:

</div>
<div class="help-para">
<div class="help-li-num" style=""> an overview of how it all fits together
</div><div class="help-li-num" style=""> how-to guides for common tasks such as:
</div><div class="help-li" style="margin-left: 3rem;"> (TODO) deprecating public functions
</div><div class="help-li" style="margin-left: 3rem;"> (TODO) adding a new public (API) function or (UI) event
</div>
</div>
<div class="help-para">
<h2 id="_project-layout:-where-things-go" class="help-heading">Project layout: where things go</h2>


</div>
<div class="help-para">
C CODE

</div>
<div class="help-para">
<div class="help-li" style=""> Nvim C code lives in <code>src/nvim/</code>.
</div><div class="help-li" style="margin-left: 3rem;"> This includes third-party components which we have forked and fully
      "own", meaning we no longer track the upstream. In particular: <code>vterm/</code>
      and <code>tui/termkey/</code>.
</div><div class="help-li" style=""> Vendored third-party components live in <code>src/*</code>.
</div><div class="help-li" style="margin-left: 3rem;"> <code>src/tee/</code> and <code>src/xxd/</code> have their own build files. They are shipped
      with the Windows artifact to ensure those tools exists there.
</div><div class="help-li" style="margin-left: 3rem;"> Other components like <code>src/cjson/</code> and <code>src/mpack/</code> are included with
      Nvim itself. These vendored sources are synced from upstream, we do not
      "own" them.
</div>
</div>
<div class="help-para">
See also "MAINTAIN.md".

</div>
<div class="help-para">
Generated C files use these filename conventions to hint their purpose:
<div class="help-li" style=""> <code>*.c</code>, <code>*.generated.c</code> - full C files, with all includes, etc.
</div><div class="help-li" style=""> <code>*.c.h</code> - parametrized C files, contain all necessary includes, but require
  defining macros before actually using. Example: <code>typval_encode.c.h</code>
</div><div class="help-li" style=""> <code>*.h</code> - full headers, with all includes. Does not apply to <code>*.generated.h</code>.
</div><div class="help-li" style=""> <code>*.h.generated.h</code> - exported functions’ declarations.
</div><div class="help-li" style=""> <code>*.c.generated.h</code> - static functions’ declarations.
</div>
</div>
<div class="help-para">
<h3 id="_lua-code" class="help-heading">LUA CODE</h3>


</div>
<div class="help-para">
Lua code lives in one of four places:

</div>
<div class="help-para">
<div class="help-li-num" style=""> Plugins! Not everything needs to live on <code>vim.*</code>. Plugins are the correct
   model for non-essential features which the user may disable or replace with
   a third-party plugin, and which do not have a formal API. Examples:
   "editorconfig", "comment".
</div><div class="help-li" style="margin-left: 3rem;"> "opt-out": <code>runtime/plugin/</code>
</div><div class="help-li" style="margin-left: 3rem;"> "opt-in": <code>runtime/pack/dist/opt/</code>
</div><div class="help-li-num" style=""> <code>runtime/lua/vim/</code> (the runtime): Lazy-loaded modules. Examples: <code>treesitter</code>, <code>lpeg</code>.
</div><div class="help-li-num" style=""> <code>runtime/lua/vim/_core/shared.lua</code>: pure Lua functions which always are available.
   Used in the test runner, and worker threads/processes launched from Nvim.
</div><div class="help-li-num" style=""> <code>runtime/lua/vim/_core/</code>: Eager-loaded code which directly interacts with the Nvim
   editor state. Only available in the main thread. See <a href="dev_arch.html#dev-lua-builtin">dev-lua-builtin</a>
   below.
</div>
</div>
<div class="help-para">
The top-level <code>vim.</code> namespace is for fundamental Lua and editor features. Use
submodules (<code>vim.foo</code>) for everything else (but avoid excessive "nesting"), or
plugins (see above).

</div>
<div class="help-para">
Compatibility with Vim's <code>if_lua</code> is explicitly a non-goal.

</div>
<div class="help-para">
                                                             <span id="dev-lua-builtin" class="help-tag-right"><a href="#dev-lua-builtin">dev-lua-builtin</a></span><br>
Lua modules that are necessary even if VIMRUNTIME is invalid (generally, data
structures and essential utilities), must be compiled into the <code>nvim</code> binary.
There are two ways to do that:
<div class="help-li" style=""> if they are private, put the code file in <code>runtime/lua/vim/_core/</code>
</div><div class="help-li" style=""> if they are public, choose a new filepath in <code>runtime/lua/vim/</code>
  and add it to VIM_MODULE_FILE in src/nvim/CMakeLists.txt.
</div>
</div>
<div class="help-para">
<h2 id="_data-structures" class="help-heading">Data structures</h2>


</div>
<div class="help-para">
<div class="help-li" style=""> StringBuilder
</div><div class="help-li" style=""> kvec or garray.c for dynamic lists / vectors (use StringBuilder for strings)
</div>
</div>
<div class="help-para">
Use <code>kvec.h</code> for most lists. When you absolutely need a linked list, use
<code>src/nvim/lib/queue_defs.h</code> which defines an "intrusive" linked list.

</div>
<div class="help-para">
Buffer text is stored as a tree of line segments, defined in <code>src/nvim/memline.c</code>.
The central idea is found in <code>ml_find_line</code>.

</div>
<div class="help-para">
Many of the editor concepts are defined as Lua data files:

</div>
<div class="help-para">
<div class="help-li" style=""> Events (autocmds): src/nvim/auevents.lua
</div><div class="help-li" style=""> Ex (cmdline) commands: src/nvim/ex_cmds.lua
</div><div class="help-li" style=""> Options: src/nvim/options.lua
</div><div class="help-li" style=""> Vimscript functions: src/nvim/eval.lua
</div><div class="help-li" style=""> v: variables: src/nvim/vvars.lua
</div>
</div>
<div class="help-para">
<h2 id="_events" class="help-heading">Events<span class="help-heading-tags">                                                            <span id="dev-events" class="help-tag"><a href="#dev-events">dev-events</a></span></h2>


</div>
<div class="help-para">
The events historically called "autocmds", referred to here as "editor events"
or simply "events", are high-level events for use by plugins, user config, and
the Nvim editor. (There is an unrelated, low-level concept defined by the
<code>event/defs.h#Event</code> struct, which is just a bag of data passed along the
internal <a href="dev_arch.html#event-loop">event-loop</a>.)

</div>
<div class="help-para">
Where possible, new editor events should be implemented using <code>aucmd_defer()</code>
(and where possible, old events migrate to this), so they are processed in
a predictable manner, which avoids crashes and race conditions. See
<code>do_markset_autocmd</code> for an example.

</div>
<div class="help-para">
<h2 id="_ui-events" class="help-heading">UI events<span class="help-heading-tags">                                                      <span id="dev-ui-events" class="help-tag"><a href="#dev-ui-events">dev-ui-events</a></span></h2>


</div>
<div class="help-para">
The long-term vision is that UI events are just another type of "editor event"
(formerly known as "autocmds"). There is no real reason that we have separate
types of user-facing or plugin-facing events. Events are events. Their
"transport" is irrelevant and any event should be possible to emit over any
transport (editor or RPC).

</div>
<div class="help-para">
Meanwhile the current situation is that UI events are a particular RPC event
packaged in a generic <code>redraw</code> notification. They also can be listened to
in-process via <a href="lua.html#vim.ui_attach()">vim.ui_attach()</a>.

</div>
<div class="help-para">
UI events are deferred to UIs, which implies a deepcopy of the UI event data.

</div>
<div class="help-para">
The source files most directly involved with UI events are:
<div class="help-li-num" style=""> <code>src/nvim/ui.*</code>: calls handler functions of registered UI structs (independent from msgpack-rpc)
</div><div class="help-li-num" style=""> <code>src/nvim/api/ui.*</code>: forwards messages over msgpack-rpc to remote UIs.
</div>
</div>
<div class="help-para">
UI events are defined in <code>src/nvim/api/ui_events.in.h</code> , this file is not
compiled directly, rather it parsed by
<code>src/gen/gen_api_ui_events.lua</code> which autogenerates wrapper
functions used by the source files above. It also generates metadata
accessible as <code>api_info().ui_events</code>.

</div>
<div class="help-para">
See commit d3a8e9217f39c59dd7762bd22a76b8bd03ca85ff for an example of adding
a new UI event. Remember to bump NVIM_API_LEVEL if it wasn't already during
this development cycle.

</div>
<div class="help-para">
Other references:
<div class="help-li" style=""> <a href="api.html#msgpack-rpc">msgpack-rpc</a>
</div><div class="help-li" style=""> <a href="api-ui-events.html#ui">ui</a>
</div><div class="help-li" style=""> <a href="https://github.com/neovim/neovim/pull/3246">https://github.com/neovim/neovim/pull/3246</a>
</div><div class="help-li" style=""> <a href="https://github.com/neovim/neovim/pull/18375">https://github.com/neovim/neovim/pull/18375</a>
</div><div class="help-li" style=""> <a href="https://github.com/neovim/neovim/pull/21605">https://github.com/neovim/neovim/pull/21605</a>
</div>
</div>
<div class="help-para">
<h2 id="_api" class="help-heading">API</h2>


</div>
<div class="help-para">
                                                        <span id="dev-api-fast" class="help-tag-right"><a href="#dev-api-fast">dev-api-fast</a></span><br>
API functions and Vimscript "eval" functions may be marked as <a href="api.html#api-fast">api-fast</a> which
means they are safe to call in Lua callbacks and other scenarios. A functions
CANNOT be marked as "fast" if could trigger <code>os_breakcheck()</code>, which may
"yield" the current execution and start a new execution of code not expecting
this:
<div class="help-li" style=""> accidentally recursing into a function not expecting this.
</div><div class="help-li" style=""> changing (global) state without restoring it before returning to the
  "yielded" callsite.
</div>
</div>
<div class="help-para">
In practice, this means any code that could trigger <code>os_breakcheck()</code> cannot
be "fast". For example, commit 3940c435e405 fixed such a bug with
<code>nvim__get_runtime</code> by explicitly disallowing <code>os_breakcheck()</code> via the
<code>EW_NOBREAK</code> flag.

</div>
<div class="help-para">
Common examples of non-fast code: regexp matching, wildcard expansion,
expression evaluation.

</div>
<div class="help-para">
<h2 id="_the-event-loop" class="help-heading">The event-loop<span class="help-heading-tags">                                                    <span id="event-loop" class="help-tag"><a href="#event-loop">event-loop</a></span></h2>


</div>
<div class="help-para">
The internal, low-level, libuv event-loop (<a href="luvref.html#luv-event-loop">luv-event-loop</a>) is used to
schedule arbitrary work in a predictable way. One such obvious use-case for
scheduling is deferred editor-events (autocmds). Another example is
<a href="job_control.html#job-control">job-control</a>.

</div>
<div class="help-para">
<h3 id="_async-event-support" class="help-heading">ASYNC EVENT SUPPORT</h3>


</div>
<div class="help-para">
One of the features Nvim added is the support for handling arbitrary
asynchronous events, which can include:

</div>
<div class="help-para">
<div class="help-li" style=""> RPC requests
</div><div class="help-li" style=""> job control callbacks
</div><div class="help-li" style=""> timers
</div>
</div>
<div class="help-para">
Nvim implements this functionality by entering another event loop while
waiting for characters, so instead of:<pre><code class="language-py">def state_enter(on_state, data):
  do
    key = readkey()           # Read a key from the user
  while on_state(data, key)   # Invoke callback for the current state</code></pre>
the Nvim program loop is more like:<pre><code class="language-py">def state_enter(on_state, data):
  do
    event = read_next_event() # Read an event from the OS
  while on_state(data, event) # Invoke callback for current state</code></pre>
where <code>event</code> is something the operating system delivers to us, including (but
not limited to) user input. The <code>read_next_event()</code> part is internally
implemented by libuv, the platform layer used by Nvim.

</div>
<div class="help-para">
Since Nvim inherited its code from Vim, the states are not prepared to receive
"arbitrary events", so we use a special key to represent those (When a state
receives an "arbitrary event", it normally doesn't do anything other than
update the screen).

</div>
<div class="help-para">
<h3 id="_main-loop" class="help-heading">MAIN LOOP</h3>


</div>
<div class="help-para">
The <code>Loop</code> structure (which describes <code>main_loop</code>) abstracts multiple queues
into one loop:<pre>uv_loop_t uv;
MultiQueue *events;
MultiQueue *thread_events;
MultiQueue *fast_events;</pre>
<code>loop_poll_events</code> checks <code>Loop.uv</code> and <code>Loop.fast_events</code> whenever Nvim is
idle, and also at <code>os_breakcheck</code> intervals.

</div>
<div class="help-para">
MultiQueue is cool because you can attach throw-away "child queues" trivially.
For example <code>do_os_system()</code> does this (for every spawned process!) to
automatically route events onto the <code>main_loop</code>:<pre>Process *proc = &amp;uvproc.process;
MultiQueue *events = multiqueue_new_child(main_loop.events);
proc-&gt;events = events;</pre>
<h3 id="_nvim-lifecycle" class="help-heading">NVIM LIFECYCLE</h3>


</div>
<div class="help-para">
How Nvim processes input.

</div>
<div class="help-para">
Consider a typical Vim-like editing session:

</div>
<div class="help-para">
<div class="help-li-num" style=""> Vim displays the welcome screen
</div><div class="help-li-num" style=""> User types: <code>:</code>
</div><div class="help-li-num" style=""> Vim enters command-line mode
</div><div class="help-li-num" style=""> User types: <code>edit README.txt&lt;CR&gt;</code>
</div><div class="help-li-num" style=""> Vim opens the file and returns to normal mode
</div><div class="help-li-num" style=""> User types: <code>G</code>
</div><div class="help-li-num" style=""> Vim navigates to the end of the file
</div><div class="help-li-num" style=""> User types: <code>5</code>
</div><div class="help-li-num" style=""> Vim enters count-pending mode
</div><div class="help-li-num" style=""> User types: <code>d</code>
</div><div class="help-li-num" style=""> Vim enters operator-pending mode
</div><div class="help-li-num" style=""> User types: <code>w</code>
</div><div class="help-li-num" style=""> Vim deletes 5 words
</div><div class="help-li-num" style=""> User types: <code>g</code>
</div><div class="help-li-num" style=""> Vim enters the "g command mode"
</div><div class="help-li-num" style=""> User types: <code>g</code>
</div><div class="help-li-num" style=""> Vim goes to the beginning of the file
</div><div class="help-li-num" style=""> User types: <code>i</code>
</div><div class="help-li-num" style=""> Vim enters insert mode
</div><div class="help-li-num" style=""> User types: <code>word&lt;ESC&gt;</code>
</div><div class="help-li-num" style=""> Vim inserts "word" at the beginning and returns to normal mode
</div>
</div>
<div class="help-para">
Note that we split user actions into sequences of inputs that change the state
of the editor. While there's no documentation about a "g command mode" (step
16), internally it is implemented similarly to "operator-pending mode".

</div>
<div class="help-para">
From this we can see that Vim has the behavior of an input-driven state machine
(more specifically, a pushdown automaton since it requires a stack for
transitioning back from states). Assuming each state has a callback responsible
for handling keys, this pseudocode represents the main program loop:<pre><code class="language-py">def state_enter(state_callback, data):
  do
    key = readkey()                 # read a key from the user
  while state_callback(data, key)   # invoke the callback for the current state</code></pre>

</div>
<div class="help-para">
That is, each state is entered by calling <code>state_enter</code> and passing a
state-specific callback and data. Here is a high-level pseudocode for a program
that implements something like the workflow described above:<pre><code class="language-py">def main()
  state_enter(normal_state, {}):
def normal_state(data, key):
  if key == ':':
    state_enter(command_line_state, {})
  elif key == 'i':
    state_enter(insert_state, {})
  elif key == 'd':
    state_enter(delete_operator_state, {})
  elif key == 'g':
    state_enter(g_command_state, {})
  elif is_number(key):
    state_enter(get_operator_count_state, {'count': key})
  elif key == 'G'
    jump_to_eof()
  return true
def command_line_state(data, key):
  if key == '&lt;cr&gt;':
    if data['input']:
      execute_ex_command(data['input'])
    return false
  elif key == '&lt;esc&gt;'
    return false
  if not data['input']:
    data['input'] = ''
  data['input'] += key
  return true
def delete_operator_state(data, key):
  count = data['count'] or 1
  if key == 'w':
    delete_word(count)
  elif key == '$':
    delete_to_eol(count)
  return false  # return to normal mode
def g_command_state(data, key):
  if key == 'g':
    go_top()
  elif key == 'v':
    reselect()
  return false  # return to normal mode
def get_operator_count_state(data, key):
  if is_number(key):
    data['count'] += key
    return true
  unshift_key(key)  # return key to the input buffer
  state_enter(delete_operator_state, data)
  return false
def insert_state(data, key):
  if key == '&lt;esc&gt;':
    return false  # exit insert mode
  self_insert(key)
  return true</code></pre>

</div>
<div class="help-para">
The above gives an idea of how Nvim is organized internally. Some states like
the <code>g_command_state</code> or <code>get_operator_count_state</code> do not have a dedicated
<code>state_enter</code> callback, but are implicitly embedded into other states (this
will change later as we continue the refactoring effort). To start reading the
actual code, here's the recommended order:

</div>
<div class="help-para">
<div class="help-li-num" style=""> <code>state_enter()</code> function (state.c). This is the actual program loop,
   note that a <code>VimState</code> structure is used, which contains function pointers
   for the callback and state data.
</div><div class="help-li-num" style=""> <code>main()</code> function (main.c). After all startup, <code>normal_enter</code> is called
   at the end of function to enter normal mode.
</div><div class="help-li-num" style=""> <code>normal_enter()</code> function (normal.c) is a small wrapper for setting
   up the NormalState structure and calling <code>state_enter</code>.
</div><div class="help-li-num" style=""> <code>normal_check()</code> function (normal.c) is called before each iteration of
   normal mode.
</div><div class="help-li-num" style=""> <code>normal_execute()</code> function (normal.c) is called when a key is read in normal
   mode.
</div>
</div>
<div class="help-para">
The basic structure described for normal mode in 3, 4 and 5 is used for other
modes managed by the <code>state_enter</code> loop:

</div>
<div class="help-para">
<div class="help-li" style=""> command-line mode: <code>command_line_{enter,check,execute}()</code>(<code>ex_getln.c</code>)
</div><div class="help-li" style=""> insert mode: <code>insert_{enter,check,execute}()</code>(<code>edit.c</code>)
</div><div class="help-li" style=""> terminal mode: <code>terminal_{enter,execute}()</code>(<code>terminal.c</code>)
</div>
</div>
<div class="help-para">
<h3 id="_important-variables" class="help-heading">IMPORTANT VARIABLES</h3>


</div>
<div class="help-para">
The current mode is stored in <code>State</code>.  The values it can have are <code>MODE_NORMAL</code>,
<code>MODE_INSERT</code>, <code>MODE_CMDLINE</code>, and a few others.

</div>
<div class="help-para">
The current window is <code>curwin</code>.  The current buffer is <code>curbuf</code>.  These point
to structures with the cursor position in the window, option values, the file
name, etc.

</div>
<div class="help-para">
All the global variables are declared in <code>globals.h</code>.

</div>
<div class="help-para">
<h3 id="_the-main-event-loop" class="help-heading">THE MAIN EVENT-LOOP</h3>


</div>
<div class="help-para">
The main loop is implemented in state_enter. The basic idea is that Vim waits
for the user to type a character and processes it until another character is
needed.  Thus there are several places where Vim waits for a character to be
typed.  The <code>vgetc()</code> function is used for this.  It also handles mapping.

</div>
<div class="help-para">
What we consider the "Nvim event loop" is actually a wrapper around <code>uv_run</code> to
handle both the <code>fast_events</code> queue and possibly (a suitable subset of) deferred
events. Therefore "raw" <code>vim.uv.run()</code> is often not enough to "yield" from Lua
plugins; instead they can call <code>vim.wait(0)</code>.

</div>
<div class="help-para">
Updating the screen is mostly postponed until a command or a sequence of
commands has finished.  The work is done by <code>update_screen()</code>, which calls
<code>win_update()</code> for every window, which calls <code>win_line()</code> for every line.
See the start of [drawscreen.c](drawscreen.c) for more explanations.

</div>
<div class="help-para">
<h3 id="_command-line-mode" class="help-heading">COMMAND-LINE MODE</h3>


</div>
<div class="help-para">
When typing a <code>:</code>, <code>normal_cmd()</code> will call <code>getcmdline()</code> to obtain a line with
an Ex command.  <code>getcmdline()</code> calls a loop that will handle each typed
character.  It returns when hitting <code>&lt;CR&gt;</code> or <code>&lt;Esc&gt;</code> or some other character that
ends the command line mode.

</div>
<div class="help-para">
<h3 id="_ex-commands" class="help-heading">EX COMMANDS</h3>


</div>
<div class="help-para">
Ex commands are handled by the function <code>do_cmdline()</code>.  It does the generic
parsing of the <code>:</code> command line and calls <code>do_one_cmd()</code> for each separate
command.  It also takes care of while loops.

</div>
<div class="help-para">
<code>do_one_cmd()</code> parses the range and generic arguments and puts them in the
exarg_t and passes it to the function that handles the command.

</div>
<div class="help-para">
The <code>:</code> commands are listed in [ex_cmds.lua](ex_cmds.lua).

</div>
<div class="help-para">
<h3 id="_normal-mode-commands" class="help-heading">NORMAL MODE COMMANDS</h3>


</div>
<div class="help-para">
The Normal mode commands are handled by the <code>normal_cmd()</code> function.  It also
handles the optional count and an extra character for some commands.  These
are passed in a <code>cmdarg_T</code> to the function that handles the command.

</div>
<div class="help-para">
There is a table <code>nv_cmds</code> in [normal.c](normal.c) which
lists the first character of every
command.  The second entry of each item is the name of the function that
handles the command.

</div>
<div class="help-para">
<h3 id="_insert-mode-commands" class="help-heading">INSERT MODE COMMANDS</h3>


</div>
<div class="help-para">
When doing an <code>i</code> or <code>a</code> command, <code>normal_cmd()</code> will call the <code>edit()</code> function.
It contains a loop that waits for the next character and handles it.  It
returns when leaving Insert mode.

</div>

  </div>
      <div class="col-narrow toc">
      <div><a href="index.html">Main</a></div>
      <div><a href="vimindex.html">Commands index</a></div>
      <div><a href="quickref.html">Quick reference</a></div>
      <hr/>
  <div class="help-toc-h1"><a href="#_project-layout:-where-things-go">Project layout: where things go</a>
<div class="help-toc-h2"><a href="#_lua-code">LUA CODE</a></div>
</div><div class="help-toc-h1"><a href="#_data-structures">Data structures</a>
</div><div class="help-toc-h1"><a href="#_events">Events</a>
</div><div class="help-toc-h1"><a href="#_ui-events">UI events</a>
</div><div class="help-toc-h1"><a href="#_api">API</a>
</div><div class="help-toc-h1"><a href="#_the-event-loop">The event-loop</a>
<div class="help-toc-h2"><a href="#_async-event-support">ASYNC EVENT SUPPORT</a></div>
<div class="help-toc-h2"><a href="#_main-loop">MAIN LOOP</a></div>
<div class="help-toc-h2"><a href="#_nvim-lifecycle">NVIM LIFECYCLE</a></div>
<div class="help-toc-h2"><a href="#_important-variables">IMPORTANT VARIABLES</a></div>
<div class="help-toc-h2"><a href="#_the-main-event-loop">THE MAIN EVENT-LOOP</a></div>
<div class="help-toc-h2"><a href="#_command-line-mode">COMMAND-LINE MODE</a></div>
<div class="help-toc-h2"><a href="#_ex-commands">EX COMMANDS</a></div>
<div class="help-toc-h2"><a href="#_normal-mode-commands">NORMAL MODE COMMANDS</a></div>
<div class="help-toc-h2"><a href="#_insert-mode-commands">INSERT MODE COMMANDS</a></div>
</div></div>
</div>
  <footer>
    <div class="container flex">
      <div class="generator-stats">
        Generated at 2026-01-19 05:34 from <code><a href="https://github.com/neovim/neovim/commit/30259d6af79e731491e6b12d815893b1b130b52b">30259d6</a></code>
      </div>
      <div class="generator-stats">
      parse_errors: 0 (<a href="https://github.com/neovim/neovim/issues/new?labels=bug&title=user+docs+HTML%3A+dev_arch.txt+&body=%60gen_help_html.lua%60+problem+at%3A+https://neovim.io/doc/user/dev_arch.html%0D%0DContext%3A%0D%0D%60%60%60%0DTODO%0D%60%60%60" target="_blank">report docs bug...</a>) | <span title="          Nvim
                            NVIM REFERENCE MANUAL
                                  Type &lt;a href="various.html#gO"&gt;gO&lt;/a&gt; to see the table of contents.
vim:tw=78:ts=8:sw=4:et:ft=help:norl:">noise_lines: 4</span>
      </div>
    <div>

    <!-- algolia docsearch https://docsearch.algolia.com/docs/docsearch-v3/ -->
    <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
    <script type="module">
      docsearch({
        container: '#docsearch',
        appId: 'X185E15FPG',
        apiKey: 'b5e6b2f9c636b2b471303205e59832ed',
        indexName: 'nvim',
      });
    </script>

  </footer>
  </body>
</html>
